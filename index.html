<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>TV Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background: #0f172a;
            color: white;
            overflow: hidden;
        }

        .header {
            background: #1e293b;
            padding: 25px;
            font-size: 42px;
            text-align: center;
            font-weight: bold;
            border-bottom: 4px solid #334155;
        }

        #content {
            padding: 30px;
            height: 75vh;
            display: flex;
            align-items: flex-start;
            justify-content: center;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: #1e293b;
            table-layout: fixed; 
        }

        th {
            background: #334155;
            padding: 25px;
            font-size: 36px;
            border: 2px solid #475569;
        }

        td {
            padding: 30px;
            text-align: center;
            border: 2px solid #475569;
            font-size: 32px;
            word-wrap: break-word;
        }

        .status-open { background: #065f46; }
        .status-hold { background: #78350f; }
        .status-overdue { background: #7f1d1d; }

        .fullCenter {
            height: 75vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }

        .msl {
            height: 100vh;
            display: flex;
            justify-content: space-around;
            align-items: center;
            background: #000;
            gap: 10px;
            width: 100vw;
        }

        .msl img {
            max-height: 95vh;
            border-radius: 10px;
            border: 3px solid #334155;
        }

        .notification-list {
            list-style-type: none;
            padding: 0;
        }

        .notification-list li h1 {
            margin: 40px 0;
            font-size: 60px;
        }
    </style>
</head>
<body>

<div id="displaySection">
    <div class="header" id="title">Loading Dashboard...</div>
    <div id="content"></div>
</div>

<script>
/* --- CONFIGURATION --- */
const FILE_NAME = "assignments.xlsx"; 
const SHEET_PAGINATED_TIME = 30000; // 30 seconds for paginated pages
const OTHER_DISPLAY_TIME = 12000;    // 12 seconds for everything else
const AUTO_RELOAD_MS = 120000;       
const ROWS_PER_PAGE = 5; 

const IMAGE_LIST = [
    "notice0.png",
    "notice1.png"
];

/* --- GLOBALS --- */
let workbook;
let displays = [];
let currentDisplay = 0;
let currentImage = 0;
let rotationTimeout;

window.onload = loadExcel;

async function loadExcel() {
    try {
        const response = await fetch(`${FILE_NAME}?t=${new Date().getTime()}`);
        if (!response.ok) throw new Error("File not found");
        const data = await response.arrayBuffer();
        workbook = XLSX.read(new Uint8Array(data), { type: 'array' });

        buildDisplayList();
        
        if (rotationTimeout) clearTimeout(rotationTimeout);
        startRotation();
    } catch (err) {
        document.getElementById("title").innerText = "Update Error";
        document.getElementById("content").innerHTML = `<div class="fullCenter"><h1>‚ö†Ô∏è Missing File: ${FILE_NAME}</h1></div>`;
    }
}

/* 1. SELECTIVE PAGINATION ENGINE */
function buildDisplayList() {
    displays = [];
    
    workbook.SheetNames.forEach(name => {
        const sheet = workbook.Sheets[name];
        const rows = XLSX.utils.sheet_to_json(sheet, { defval: "" });
        const lowerName = name.toLowerCase().trim();

        // ONLY paginate "Shop Visit Status"
        if (lowerName === "shop visit status") {
            if (rows.length === 0) return;
            for (let i = 0; i < rows.length; i += ROWS_PER_PAGE) {
                displays.push({ 
                    type: "sheet", 
                    name: name, 
                    isConventional: true, // Use "As-Is" format
                    isPaginated: true,    // Use 30s timer
                    start: i, 
                    end: i + ROWS_PER_PAGE,
                    page: Math.floor(i / ROWS_PER_PAGE) + 1,
                    total: Math.ceil(rows.length / ROWS_PER_PAGE)
                });
            }
        } else {
            // All other sheets (e.g. Task Card) stay as single entries
            displays.push({ 
                type: "sheet", 
                name: name, 
                isConventional: false // Use Pivot/Grouped format
            });
        }
    });

    displays.push({ type: "image" }, { type: "notification" });
}

/* 2. RENDERING */
function showSheet(displayObj) {
    const sheetName = displayObj.name;
    const sheet = workbook.Sheets[sheetName];
    let allRows = XLSX.utils.sheet_to_json(sheet, { defval: "" });

    let titleText = sheetName;
    if (displayObj.page) titleText += ` (${displayObj.page}/${displayObj.total})`;
    document.getElementById("title").innerText = titleText;

    const headers = Object.keys(allRows[0] || {});
    let html = "<table>";

    // MODE: CONVENTIONAL (Shop Visit Status)
    if (displayObj.isConventional) {
        const pagedRows = allRows.slice(displayObj.start, displayObj.end);
        html += "<tr>" + headers.map(h => `<th>${h}</th>`).join("") + "</tr>";
        pagedRows.forEach(row => {
            html += "<tr>" + headers.map(h => `<td>${row[h]}</td>`).join("") + "</tr>";
        });
        
        // Fill empty rows to maintain layout
        for(let i = pagedRows.length; i < ROWS_PER_PAGE; i++) {
            html += "<tr>" + headers.map(() => `<td>&nbsp;</td>`).join("") + "</tr>";
        }
    } 
    // MODE: GROUPED/PIVOT (Task Card / Others)
    else {
        let personCol = detectColumn(headers, ["assigned", "person", "owner", "Shop Engineer"]) || headers[0];
        let snCol = detectColumn(headers, ["sn", "serial", "ESN", "job"]) || headers[1];
        let statusCol = detectColumn(headers, ["status", "state"]);

        const peopleMap = {};
        allRows.forEach(r => {
            const status = statusCol ? String(r[statusCol]) : "";
            if (status.toLowerCase() === "complete") return;
            const person = r[personCol] || "Unknown";
            if (!peopleMap[person]) peopleMap[person] = [];
            peopleMap[person].push({
                text: (r[snCol] || "") + (status ? " - " + status : ""),
                status: status
            });
        });

        const people = Object.keys(peopleMap);
        html += "<tr>" + people.map(p => `<th>${p}</th>`).join("") + "</tr>";
        let maxRows = Math.max(...people.map(p => peopleMap[p].length), 0);
        
        for (let i = 0; i < maxRows; i++) {
            html += "<tr>";
            people.forEach(p => {
                const item = peopleMap[p][i];
                html += item ? `<td class="${getStatusClass(item.status)}">${item.text}</td>` : "<td></td>";
            });
            html += "</tr>";
        }
    }
    
    html += "</table>";
    document.getElementById("content").innerHTML = html;
}

function showImage() {
    document.getElementById("title").innerText = "Maintenance Service Letters";
    const img = IMAGE_LIST[currentImage];
    const img2 = IMAGE_LIST[(currentImage + 1) % IMAGE_LIST.length];
    currentImage = (currentImage + 2) % IMAGE_LIST.length;

    document.getElementById("content").innerHTML = `
        <div class="msl"><img src="${img}"><img src="${img2}"></div>`;
}

function showNotification() {
    document.getElementById("title").innerText = "Notifications";
    document.getElementById("content").innerHTML = `
        <div class="fullCenter">
            <ul class="notification-list">
                <li><h1>üì¢ Update Status Regularly</h1></li>
                <li><h1>üì¢ Crew meeting at 4 PM</h1></li>
            </ul>
        </div>`;
}

/* 3. ROTATION ENGINE */
function startRotation() {
    runDisplay();
    
    const currentObj = displays[currentDisplay];
    // Use 30s only for the paginated pages of Shop Visit Status
    const waitTime = (currentObj.isPaginated) ? SHEET_PAGINATED_TIME : OTHER_DISPLAY_TIME;

    rotationTimeout = setTimeout(() => {
        currentDisplay = (currentDisplay + 1) % displays.length;
        startRotation();
    }, waitTime);
}

function runDisplay() {
    const d = displays[currentDisplay];
    if (d.type === "sheet") showSheet(d);
    else if (d.type === "image") showImage();
    else if (d.type === "notification") showNotification();
}

/* 4. UTILS */
function detectColumn(headers, options) {
    for (let opt of options) {
        const found = headers.find(h => h.toLowerCase().includes(opt));
        if (found) return found;
    }
    return null;
}

function getStatusClass(status) {
    if (!status) return "";
    const s = String(status).toLowerCase();
    if (s.includes("open") || s.includes("inspection")) return "status-open";
    if (s.includes("hold") || s.includes("assembly")) return "status-hold";
    if (s.includes("overdue") || s.includes("test")) return "status-overdue";
    return "";
}

setInterval(loadExcel, AUTO_RELOAD_MS);
</script>
</body>
</html>


